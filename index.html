<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Tractography</title>
    <link rel="stylesheet" href="https://raw.githubusercontent.com/niivue/niivue/main/demos/features/light.css">
  </head>
  <body>
    <noscript>
      <strong>niivue doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <header>
     
    <div id='subjectAndSession'>
      <label>Subject: </label>   
      <select v-model="subjectId" @change="update">
        <option v-for="subject in subjects" :value="subject">{{subject.id}}</option>
      </select>
      <label> Session: </label>
      {{subjectId.session}}
    </div>
    
      <div id ='checkedboxes'>
        <label>Bundles To Include: </label>
        <br>
        
        <label><input type="checkbox" v-model = "toggled" @change="toggle">Toggle All</label>
        <table>
          <td v-for="bundleType in bundleTypes">
            <label>{{bundleType.name}}</label>
            <input type="checkbox" v-model="bundles" @change="update" :value="bundleType.id">
          </td>
        </table>
      </div>

      
      </header>
    <main id="container">
        <canvas id="gl1" width="1258" style="width: 100%; height: 80%;" height="800" tabindex="0">
        </canvas>
    </main>
  </body>
</html>
<script src="https://unpkg.com/@niivue/niivue@0.32.0/dist/niivue.umd.js">
</script>
<script src = "https://unpkg.com/vue@3"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src = "./functions.js"></script>
<script defer>
  function changeVolumeList(subjectData) {
    var volumeList1 = [
	// first item is background image
	 {
	   url: subjectData[0][0],//"./images/RAS.nii.gz", "./images/spm152.nii.gz",

     //url: "httpes://fcp-indi.s3.amazonaws.com/data/Projects/HBN/BIDS_curated/derivatives/afq/sub-NDARAA947ZG5/ses-HBNsiteCBIC/sub-NDARAA947ZG5_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi_model-DKI_AWF.nii.gz",
     colorMap: "gray",
	   opacity: 1,
	   visible: true,
	 },
	]
    var nv1 = new niivue.Niivue(({
  		show3Dcrosshair: true,//displays crosshair
  		backColor: [0.8, 0.8, 1, 1]}))//sets the background color.
  	nv1.setSliceType(nv1.sliceTypeRender)//I don't know exactly what this does but when it is removed all three directions of slices are displayed
  	nv1.attachTo('gl1')//attaches the entire image to the canvas.
    for (var q = 0; q<subjectData[1].length; q++){
      
      nv1.loadMeshes([
    	 {url: subjectData[0][1][subjectData[1][q]], rgba255 : [0, 0, 255, 255]},
    	])//displays the fiber
    }
  	
  	nv1.setClipPlane([-0.1, 270, 0])	//displays the clip plane. displaced in the x? direction by 0.1. rotated 270 degrees about the z axis. The third number clearly has to do with angle and initial position in the z direction but my experimentation is not leading me to a clear result.
    console.log(volumeList1)
    nv1.loadVolumes(volumeList1)//Displayes the brain.
  }
  //////Vue dropdown fully done.a
  const dropVueApp = Vue.createApp({
    data(){
      return{
        subjects:fullArrayAsClass(returnFullArray()),
        subjectId:fullArrayAsClass(returnFullArray())[0],
      }
    },
    methods:{
      update(){
        changeVolumeList([arrayBasedOnSubjectAndSite([this.subjectId.id, this.subjectId.session], "https://fcp-indi.s3.amazonaws.com/data/Projects/HBN/BIDS_curated"), checkboxVueApp.bundles])
      }
    }
  }).mount(subjectAndSession)
  
  
  //////Vue checkboxes fully done.
  const checkboxVueApp = Vue.createApp({
    data(){
      return{
        bundleTypes:[
          {name: 'Anterior Frontal', id: 0}, 
          {name: 'Arcuate Fasciculus-Left', id: 1},
          {name: 'Arcuate Fasciculus-Right', id: 2},
          {name: 'Anterior Thalamic Radiation-Left', id: 3},
          {name: 'Anterior Thalamic Radiation-Right', id: 4},
          {name: 'Cingulate Cingulum-Left', id: 5},
          {name: 'Cingulate Cingulum-Right', id: 6},
          {name: 'Corticospinal Tract-Left', id: 7},
          {name: 'Corticospinal Tract-Right', id: 8},
          {name: 'Inferior Fronto-Occipital Fasciculus-Left', id: 9},
          {name: 'Inferior Fronto-Occipital Fasciculus-Right', id: 10},
          {name: 'Inferior Longitudinal Fasciculus-Left', id: 11},
          {name: 'Inferior Longitudinal Fasciculus-Right', id: 12},
          {name: 'Motor', id: 13},
          {name: 'Occipital', id: 14},
          {name: 'Orbital', id: 15},
          {name: 'Posterior Parietal', id: 16},
          {name: 'Superior Longitudinal Fasciculus-Left', id: 17},
          {name: 'Superior Longitudinal Fasciculus-Right', id: 18},
          {name: 'Superior Frontal', id: 19},
          {name: 'Superior Parietal', id: 20},
          {name: 'Temporal', id: 21},
          {name: 'Uncinate Fasciculus-Left', id: 22},
          {name: 'Uncinate Fasciculus-Right', id: 23}
        ],
        bundles:[],
        toggled:false
      }
    },
    methods:{
      update(){
        changeVolumeList([arrayBasedOnSubjectAndSite([dropVueApp.subjectId.id, dropVueApp.subjectId.session], "https://fcp-indi.s3.amazonaws.com/data/Projects/HBN/BIDS_curated"), this.bundles])
        if (this.bundles.length < 24){
          this.toggled = false
        }
      },
      toggle(){
        this.bundles = []
        if (this.toggled){
          for (bundleType in this.bundleTypes){
            this.bundles.push(bundleType)
          }
        }
      this.update()
      }
    }
  }).mount('#checkedboxes')
  
  //////tsv work that is not working yet.
  /*
  newArray = []
  data = fetch("/participants.tsv")
  var mytsvstr = String(data);
  var tsvdata = d3.tsvParse(mytsvstr);
  console.log(tsvdata, 'is the data i hope')
  
  
  data = d3.tsv("participants.tsv")
  newArray = []
  console.log(data)
  data.forEach((e) => {
      newArray.push([e.participant_id, e.site])
      //console.log(newArray)
  })
  console.log(newArray)
  console.log(newArray, 'hello')
  */
  
  
  ////// this is not dependent on anything in particular from this dataset. should be it's own js file.
  
  
  //////shows default brain
  defaultValue = arrayBasedOnSubjectAndSite(['sub-NDARAA306NT2', 'RU'], "https://fcp-indi.s3.amazonaws.com/data/Projects/HBN/BIDS_curated")
  console.log(defaultValue)
  changeVolumeList([defaultValue, []])
  
  //////can be in a diff js file. also can adapt to include other similarly structured s3 buckets.
</script>
